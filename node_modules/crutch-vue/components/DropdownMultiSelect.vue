<template>
    <div class="cf-dropdown-multiselect">
        <button type="button"
                class="cf-dropdown dropdown-toggle btn bg-white border"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                aria-expanded="false"
                :disabled="disabled">
            <span v-if="buttonText.length === 0" class="dropdown-text invisible">Placeholder</span>
            <span v-else class="dropdown-text">{{ buttonText }}</span>

            <Icon name="caret-down" class="ms-extra-tight animated-caret" />
        </button>

        <ul class="dropdown-menu p-none w-100" aria-labelledby="listselectorbutton">
            <li class="list-group-item py-extra-tight">
                <label class="form-check-label w-100">
                    <input @change="selectAll()"
                           type="checkbox"
                           class="form-check-input me-tight"
                           :checked="isSelectAllChecked"
                           :disabled="disabled" />
                    Select all
                </label>
            </li>

            <li v-for="(item, index) in listItems"
                :key="index"
                :class="getListClass(item.isDivider)">
                <label v-if="!item.isDivider" class="form-check-label w-100">
                    <input v-model="selectedItems"
                           :value="item.value"
                           type="checkbox"
                           class="form-check-input me-tight"
                           :disabled="disabled" />
                    {{ item.name }}
                </label>

                <span v-else>{{ item.name }}</span>
            </li>
        </ul>
    </div>    
</template>

<script lang="ts">
    import { computed, defineComponent } from 'vue'

    // Components
    import Icon from './Icon';
    /* Usage:
       Property list example:
       const objectList = [
        { name: 'ZoneA', isDivider: true, value: '' },
        { name: 'Z101', isDivider: false, value: 'Z101' },
       ];

       Event:
       To use the modelValue on the client side, @update:modelValue="eventHandler"

       Output:
       Array<Object.value>
    */
    export default defineComponent({
        name: 'DropdownMultiSelect',
        components: {
            Icon
        },
        props: {
            /* Complete list of items, both checked and unchecked. */
            listItems: {
                type: Object as () => Array<{ name: string, isDivider: boolean, value: string }>,
                default: []
            },
            // The selected list. To use the Event on the client side, @update:modelValue="eventHandler"
            modelValue: {
                type: Object as () => Array<string>,
                default: []
            },
            disabled: {
                type: Boolean,
                default: false
            },
            buttonText: {
                type: String,
                default: ''
            },
        },
        setup(props, { emit }) {
            const buttonText = computed({
                get: () => props.buttonText,
                set(value) {
                    emit('update:buttonText', value);
                }
            });

            const valueListLength = computed(() => {
                return props.listItems?.filter((item: { isDivider: boolean }) => !item.isDivider)?.length ?? 0;
            });

            const selectedItems = computed({
                get: () => props.modelValue,
                set(value) {
                    emit('update:modelValue', value);
                }
            });
            console.log('value', props.modelValue);
            const isSelectAllChecked = computed(() => {

                let selectedItemsLength = selectedItems?.value?.length ?? 0;

                return (valueListLength.value > 0) ? (valueListLength.value === selectedItemsLength) : false;
            });

            const selectAll = () => {
                const onlyValuesList = props.listItems.filter((item: { isDivider: boolean }) => !item.isDivider)
                    .map((item: { value: string }) => item.value);

                // If all items are selected, unselected them.
                if (valueListLength.value === selectedItems.value.length) {
                    selectedItems.value = [];
                } else {
                    selectedItems.value = onlyValuesList;
                }
            }

            function getListClass(isDivider: boolean) {
                if (isDivider) {
                    return 'ps-base text-primary';
                } else {
                    return 'list-group-item py-extra-tight';
                }
            }

            return {
                selectAll,
                selectedItems,
                isSelectAllChecked,
                getListClass,
                buttonText,
            }
        },
    })
</script>

<style lang="scss">
    .cf-dropdown-multiselect {
        position: relative;

        .cf-dropdown.dropdown-toggle {
            align-items: center;
            display: flex;
            justify-content: space-between;
            text-align: left;
            width: 100%;

            .dropdown-text {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .icon {
                white-space: nowrap;
            }
        }

        .dropdown-menu {
            max-height: 400px;
            overflow: auto;
        }
    }
</style>