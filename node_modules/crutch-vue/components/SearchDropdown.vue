<template>
    <div class="cf-search-dropdown dropdown">
        <div class="input-group" :class="{ 'input-group-sm': small }">
            <input ref="dropdownToggle" :value="modelValue"
                   @input="$emit('update:modelValue', ($event.target as HTMLInputElement).value)"
                   @focus="showOrHideDropdown"
                   @blur="showOrHideDropdown"
                   @keydown.tab="wasTabbed = true"
                   id="checkboxsearchterm"
                   class="form-control dropdown-toggle"
                   placeholder="Type to search..."
                   type="text"
                   autocomplete="off" />

            <span class="input-group-text" tabindex="-1">
                <Icon name="search" />
            </span>

            <ul class="dropdown-menu w-100 p-none">             
                <li v-for="(item, index) in listItems"
                    v-show="(modelValue.length > 0) ? item.toUpperCase().includes(modelValue.toUpperCase()) : true"
                    class="list-group-item dropdown-item rounded-0 py-extra-tight"
                    :class="{ 'active' : isSelectedItem(item) }"
                    :key="index">
                    <button class="btn-no-style text-start w-100" 
                            @click="searchItemSelected(item)"
                            @focus="dropdownItemFocusOrBlur"
                            @blur="dropdownItemFocusOrBlur"
                            type="button"
                            :title="item">
                        {{ item }}
                    </button>                    
                </li>
            </ul>
        </div>
    </div>
</template>

<script lang="ts">
    import { defineComponent, ref, Ref } from 'vue'
    import Icon from './Icon';
    import { Dropdown } from 'crutchstrap/js/dropdown';
    import debounce from 'lodash/debounce';

    export default defineComponent({
        name: "SearchDropdown",
        components: {
            Icon,            
        },
        props: {
            listItems: {
                type: Object as () => Array<string>,
                default: []
            },
            // The selected value
            modelValue: {
                type: String,
                default: ""
            },
            // apply input-group-sm
            small: {
                type: Boolean,
                default: false
            }
        },
        setup(props: any, { emit }) {
            const dropdownToggle: Ref<null | HTMLInputElement> = ref(null);
            const wasTabbed = ref(false);

            const showOrHideDropdown = debounce((event: Event) => {
                const dropdown = Dropdown.getOrCreateInstance(dropdownToggle.value as HTMLInputElement);

                switch (event.type) {
                    case 'focus':
                        dropdown.show();

                        return;
                    case 'blur':
                        if (wasTabbed.value) {
                            return;
                        }

                        dropdown.hide();

                        wasTabbed.value = false;

                        return;
                }
            }, 100);

            const dropdownItemFocusOrBlur = debounce((event: Event) => {
                const dropdown = Dropdown.getOrCreateInstance(dropdownToggle.value as HTMLInputElement);

                switch (event.type) {
                    case 'focus':
                        dropdown.show();

                        return;
                    case 'blur':
                        dropdown.hide();

                        wasTabbed.value = false;

                        return;
                }
            }, 100);

            const searchItemSelected = (value: string) => {
                emit('update:modelValue', value);
                emit('change:searchItemSelected', value);

                const dropdown = Dropdown.getOrCreateInstance(dropdownToggle.value as HTMLInputElement);

                dropdown.hide();

                wasTabbed.value = false;
            };

            const isSelectedItem = (value: string) => {
                return value.toLowerCase() === props.modelValue.toLowerCase();
            };

            return {
                dropdownToggle,
                dropdownItemFocusOrBlur,
                wasTabbed,
                showOrHideDropdown,
                searchItemSelected,
                isSelectedItem,
            }
        }
    });
</script>

<style lang="scss">
    @import "~crutchstrap/vue-foundation.scss";

    .cf-search-dropdown {
        .dropdown-menu {
            max-height: 300px;
            overflow: auto;
        }

        .dropdown-menu .dropdown-item.active button {
            color: $white;
        }

        .dropdown-menu .dropdown-item button {            
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
    }
</style>