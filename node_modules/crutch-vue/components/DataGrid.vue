<template>
    <div class="cf-data-grid table-container bg-white" role="rowgroup" :class="{ 'sticky-top' : stickyHeader}">
        <div class="flex-table">
            <div class="checkbox-item header" v-if="includeCheckboxes">
                <input id="selectall"
                       type="checkbox"
                       v-model="selectAll"
                       class="form-check-input" />
            </div>

            <div class="flex-item header cursor-pointer"
                 @click="sortByHeader(header.propertyName)"
                 v-for="(header, index) in headers"
                 :key="index">
                {{ header.headerName }}
                <!--<Icon id="arrowIcon" name="caret-up" width="15" height="15" class="arrow-icon ms-tight" />-->
            </div>
        </div>

        <div class="flex-table"
             :class="[{'cursor-pointer': rowHasFunction}, item.customRowStyling ]"
             @click="rowFunction(item)"
             v-for="(item, index) in sortedRows"
             :key="index">
            <div class="checkbox-item" v-if="includeCheckboxes">
                <input type="checkbox"
                       class="form-check-input"
                       @click.stop
                       :value="item"
                       v-model="selectedItems" />
            </div>

            <div class="flex-item"
                 v-show="value.display"
                 v-for="(value, key) in item"
                 :key="key" 
                 :class="value.cellStyling">

                <span v-if="value.link === '' && !value.hasToolTip">
                    {{ value.name }}
                </span>

                <a v-if="value.link !== ''"
                   :href="value.link"
                   target="_blank">
                    {{ value.name }}
                </a>

                <div v-if="value.hasToolTip"
                     data-bs-toggle="tooltip"
                     data-bs-placement="top"
                     :title="value.toolTipText">
                    {{ value.name }}
                </div>
            </div>
        </div>

        <div v-if="!sortedRows">
            No results found.
        </div>
    </div>
</template>

<script lang="ts">
    import { defineComponent, computed, onMounted, PropType } from 'vue';
    import Icon from './Icon';
    import { SetupTooltips } from 'crutchstrap/js/tooltip';

    const DataGrid = defineComponent({
        name: 'DataGrid',
        props: {
            headers: {
                type: Object as () => Array<{}>,
                default: []
            },
            rows: {
                type: Object as () => Array<{}>,
                default: []
            },
            modelValue: {
                type: Object as () => Array<{}>,
                default: []
            },
            includeCheckboxes: {
                type: Boolean,
                default: false
            },
            rowHasFunction: {
                type: Boolean,
                default: false
            },
            rowFunction: {
                type: Function,
                default: () => { }
            },
            hasStickyHeader: {
                type: Boolean,
                default: false
            },
            customSorting: {
                type: Object as PropType<customSortType>,
                default: {
                    isCustomSort: false,
                    customSortFunction: () => {}
                }
            }
        },
        components: {
            Icon
        },
        setup(props: any, { emit }) {
            onMounted(() => {
                SetupTooltips();
            });

            const sortByHeader = (header: String) => {
                if (header === props.rows.currentSort) {
                    props.rows.currentSortDir = (props.rows.currentSortDir === 'asc' ? 'desc' : 'asc');
                }
                props.rows.currentSort = header;
            }

            const isCustom = props.customSorting.isCustomSort;
            const stickyHeader = props.hasStickyHeader;

            const sortedRows = computed(() => {
                // modifier handles reversing the numbers based on the direction of the sort
                let modifier = 1;
                if (props.rows.length > 0) {
                    if (!isCustom) {
                        return props.rows.sort((a: any, b: any) => {
                            if (props.rows.currentSortDir === 'desc') {
                                modifier = -1;
                            }

                            const varA = a[props.rows.currentSort]?.name ?? '';
                            const varB = b[props.rows.currentSort]?.name ?? '';

                            if (varA > varB) {
                                return (1 * modifier);
                            }

                            if (varA < varB) {
                                return (-1 * modifier);
                            }

                            return 0;
                        })
                    }
                    else {
                        return props.customSorting.customSortFunction(props.rows);
                    }
                }
            })

            const selectedItems = computed({
                get: () => props.modelValue,
                set(value) {
                    emit('update:modelValue', value);
                }
            });

            const selectAll = computed({
                get() {
                    return sortedRows.value ? selectedItems.value.length === sortedRows.value.length : false;
                },
                set(value) {
                    let selected: Array<{}> = [];

                    if (value) {
                        sortedRows.value.forEach((row: any) => selected.push(row));
                    }
                    selectedItems.value = selected;
                }
            });

            return {
                selectedItems,
                selectAll,
                sortByHeader,
                sortedRows,
                stickyHeader
            }
        }
    });

    type customSortType = {
        isCustomSort: Boolean,
        customSortFunction: (props: any) => {},
    }

    export default DataGrid

    export {
        DataGrid
    }
</script>

<style lang="scss">
    /// <reference path="../node_modules/crutchstrap/crutchstrap.scss" />
    @import "~crutchstrap/vue-foundation.scss";

    .cf-data-grid {
        &.table-container {
            display: block;
            margin: $loose auto;
            width: 90%;
        }

        .header {
            background: $slate-2;
            font-weight: bold;

            &.checkbox-item,
            &.flex-item {
                text-align: left;
                display: inline;
                justify-content: center;
                border-bottom: 2px solid $slate-8;
            }

            &:hover {
                background: $slate-2;
            }
        }

        .flex-table {
            display: flex;
            justify-content: space-between;
            grid-template-columns: repeat(auto-fill, 25%);
            grid-template-rows: 100% auto;
            text-align: center;
            transition: 0.5s;
        }

        .flex-row {
            &:hover {
                background: $slate-2;
                transition: 500ms;
            }
        }

        .flex-item {
            border: solid 1px $slate-4;
            padding: 0.5em 0.5em;
            text-align: left;
            width: 100%;
        }

        .checkbox-item {
            border: solid 1px $slate-4;
            padding: 0.5em 0.5em;
            text-align: center;
        }

        .positive-qty {
            background-color: $piedmont-1;
            color: $piedmont;
        }

        .negative-qty {
            background-color: $skyline-3;
            color: $skyline;
        }

        .discrepancy {
            background: $maize-4;
            border-left-width: 7px;
            border-left: 8px solid $maize-9;
            margin-left: -8px;
        }
    }    
</style>