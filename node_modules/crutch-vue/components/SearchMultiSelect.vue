<template>
    <div class="cf-search-multiselect dropdown">
        <div class="input-group input-group-sm">
            <input v-model="searchTerm"
                   id="checkboxsearchterm"
                   class="form-control dropdown-toggle"
                   aria-describedby="search-addon-writers"
                   aria-label="Featured writer name"
                   data-bs-toggle="dropdown"
                   data-bs-auto-close="outside"
                   placeholder="Type to search..."
                   type="text"
                   autocomplete="off" />

            <span class="input-group-text" tabindex="-1">
                <Icon name="search" />
            </span>

            <ul class="dropdown-menu p-none" aria-labelledby="checkboxsearchterm">
                <li class="list-group-item py-extra-tight">
                    <input id="selectall"
                           @change="selectAll(listItems)"
                           type="checkbox"
                           class="form-check-input me-tight"
                           :checked="isCheckedSelectAll" />
                    <label class="form-check-label" for="selectall">Select all</label>
                </li>
                <li v-for="item in listItems"
                    v-show="(searchTerm.length > 0) ? item.toUpperCase().includes(searchTerm.toUpperCase()) : true"
                    :key="item"
                    class="list-group-item py-extra-tight">
                    <input :id="item.toLowerCase().replaceAll(' ', '')"
                           v-model="selectedItems"
                           :value="item"
                           type="checkbox"
                           class="form-check-input me-tight" />
                    <label class="form-check-label" :for="item.toLowerCase().replaceAll(' ', '')">
                        {{ item }}
                    </label>
                </li>
            </ul>
        </div>
    </div>
</template>

<script lang="ts">
    import { computed, defineComponent, ref } from 'vue'
    import Icon from './Icon';

    export default defineComponent({
        name: "SearchMultiSelect",
        components: {
            Icon
        },
        props: {
            // Complete list of items, both checked and unchecked.
            listItems: {
                type: Object as () => Array<string>,
                default: []
            },
            // The selected list of writers
            modelValue: {
                type: Object as () => Array<string>,
                default: []
            }
        },
        setup(props: any, { emit }) {
            const searchTerm = ref('');

            const selectedItems = computed({
                get: () => props.modelValue,
                set(value) {
                    emit('update:modelValue', value);
                    emit('refreshList');
                }
            });

            const isCheckedSelectAll = computed(() => {

                let listItemsLength = props.listItems?.length ?? 0;
                let selectedItemsLength = selectedItems?.value?.length ?? 0;

                // If we have a searchTerm, base selectAll off the filtered list.
                if (searchTerm.value.length > 0) {
                    // Get the list of items filtered by the searchTerm.
                    const filteredItems = props.listItems.filter((item: string) => item.toUpperCase().includes(searchTerm.value.toUpperCase()));
                    const filteredSelectedItems = selectedItems?.value?.filter((item: string) => item.toUpperCase().includes(searchTerm.value.toUpperCase()));

                    listItemsLength = filteredItems?.length ?? 0;
                    selectedItemsLength = filteredSelectedItems?.length ?? 0;
                }
                // If neither list has data, set Select All to unchecked.
                if ((listItemsLength + selectedItemsLength) === 0) {
                    return false;
                }

                return listItemsLength === selectedItemsLength;
            });

            const selectAll = (items: Array<string>) => {

                // If we have a searchTerm, base selectAll off the filtered list.
                if (searchTerm.value.length > 0) {
                    // Get the list of items filtered by the searchTerm.
                    const filteredItems = items.filter((item: string) => item.toUpperCase().includes(searchTerm.value.toUpperCase()));
                    const filteredSelectedItems = selectedItems?.value?.filter((item: string) => item.toUpperCase().includes(searchTerm.value.toUpperCase()));

                    // Make deep copy of selectedItems so it can be modified. We use this copy to update selectedItems so events fire.
                    let copySelectedItems = JSON.parse(JSON.stringify(selectedItems.value));

                    // Check if all of the filtered items are already in the selectedItems list. Must sort to do the string compare.
                    const allSelected = (JSON.stringify(filteredItems.sort()) === JSON.stringify(filteredSelectedItems.sort()));

                    // If all of the filtered items are in the selectedItems list, we should unselect them.
                    if (allSelected) {
                        filteredItems.forEach(item => {
                            const index = copySelectedItems.indexOf(item);
                            if (index > -1) {
                                copySelectedItems.splice(index, 1);
                            }
                        });
                    } else {
                        // If some of the items are not selected, add them to the selected list.
                        filteredItems.forEach(item => {
                            if (!copySelectedItems.includes(item)) {
                                copySelectedItems.push(item);
                            }
                        });
                    }

                    // Copy modified array back to selectedItems so update events fire.
                    selectedItems.value = copySelectedItems;

                } else {
                    // If all items are selected, unselected them.
                    if (items.length === selectedItems.value.length) {
                        selectedItems.value = [];
                        return;
                    }

                    selectedItems.value = items;
                }
            }

            return {
                selectAll,
                searchTerm,
                selectedItems,
                isCheckedSelectAll,
            }
        },
    })
</script>

<style lang="scss">
    .cf-search-multiselect {
        .dropdown-menu {
            max-height: 200px;
            overflow-y: scroll;
        }
    }
</style>